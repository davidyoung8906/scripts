import os
import argparse
import sys
import subprocess

#parser = argparse.ArgumentParser(description='Generate SVG of callgraph and sub-callgraph for given APK')
#saveout = sys.stdout
currentdir = os.getcwd()
category = "MALWARE"
rootdir = os.path.join(currentdir, "CG")
for path, subdirs, files in os.walk(rootdir):
#    for topname in tsubdirs:
#        for	path, subdirs, files in os.walk(topname):
            for name in subdirs:
                print name
                if name.endswith(".apk"):
                    filepath1 = os.path.join(path, name)
                    print filepath1
                    platformPath = os.path.join(currentdir, "platforms")


                    for path1, subdirs1, files1 in os.walk(filepath1):
                        for filename4 in files1:
                            if filename4.endswith(".dot") and filename4.startswith("nonduplicate_") and not filename4.startswith("nonduplicate_wholeCG") and not filename4.endswith("ContextWrapperstartService.dot") and not filename4.endswith("ContextWrapperstartService.dot"):
                                print filepath1
                                print filename4
                        #fsock3 = open(os.path.join(currentdir,"AnalyzingContext1.log"), 'w')
                        #sys.stdout = fsock3    
                                cmd = 'java -jar AnalyzingContextLifeCycle.jar ' + filepath1 + ' '+filename4 + ' '+category+'.xls'
                                child = subprocess.Popen(cmd, stdout = file(os.path.join(filepath1,"analyzingContextOutput.log"), 'w+'), stderr = file(os.path.join(filepath1,"analyzingContextErroutput.log"), 'w+'))
                                (output, errput) = child.communicate()
                                print "Out:'%s'" % output
                                print "Err:'%s'" % errput
                        #fp3 = os.popen(cmd3)
                        #res3 = fp3.read()
                        #print res3
                        #fsock3.close()
                        #sys.stdout = saveout
                                print 'finish analyzing '+filepath1 + ' '+filename4
                    cmd1 = 'java -jar  FillPermission.jar '+category+'.xls'
                    fp1 = os.popen(cmd1)
                    res1 = fp1.read()
                    print res1